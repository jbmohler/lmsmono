<div class="page-container">

  <!-- Fixed header -->
  <div class="page-header flex flex-col gap-3">

    <!-- Title row -->
    <div class="flex items-start justify-between gap-4">
      <div class="flex flex-col gap-0.5">
        <h1 class="text-2xl font-semibold text-gray-900">
          @if (accName()) {
            Reconcile: {{ accName() }}
          } @else {
            Reconcile
          }
        </h1>
        @if (recNote()) {
          <p class="text-sm italic text-gray-500">{{ recNote() }}</p>
        }
      </div>
      <button
        class="btn btn-primary shrink-0"
        [disabled]="!canFinalize()"
        (click)="finalize()"
        title="{{ canFinalize() ? 'Mark all pending splits as reconciled' : 'Difference must be $0.00 to finalize' }}"
      >
        Finalize Reconciliation
      </button>
    </div>

    <!-- Statement inputs + running totals -->
    <div class="card p-4 input-compact">
      <div class="flex items-end gap-6 flex-wrap">
        <div>
          <label class="label-compact">Statement Date</label>
          <input
            type="date"
            [value]="statementDate()"
            (input)="statementDate.set($any($event.target).value)"
          />
        </div>
        <div>
          <label class="label-compact">Statement Balance</label>
          <input
            type="text"
            inputmode="decimal"
            placeholder="0.00"
            class="text-right w-36"
            [value]="statementBalanceStr()"
            (input)="statementBalanceStr.set($any($event.target).value)"
          />
        </div>

        <div class="flex-1"></div>

        <!-- Running totals -->
        <div class="flex gap-6 items-end">
          <div class="text-right">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Prior Reconciled</div>
            <div class="text-lg font-medium text-gray-700">
              {{ priorBalance() | currency }}
            </div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Cleared Balance</div>
            <div class="text-lg font-medium text-gray-700">
              {{ clearedBalance() | currency }}
            </div>
          </div>
          <div class="text-right">
            <div class="text-xs text-gray-500 uppercase tracking-wide">Difference</div>
            @if (difference() !== null) {
              <div
                class="text-lg font-semibold"
                [class.text-green-600]="isDifferenceZero()"
                [class.text-red-600]="!isDifferenceZero()"
              >
                {{ difference() | currency }}
              </div>
            } @else {
              <div class="text-lg font-semibold text-gray-400">—</div>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Filter tabs -->
    <div class="flex gap-1">
      <button
        class="px-3 py-1.5 text-sm font-medium rounded-md border transition-colors"
        [class.bg-blue-50]="filterMode() === 'all'"
        [class.text-blue-700]="filterMode() === 'all'"
        [class.border-blue-200]="filterMode() === 'all'"
        [class.text-gray-600]="filterMode() !== 'all'"
        [class.border-transparent]="filterMode() !== 'all'"
        [class.hover:bg-gray-50]="filterMode() !== 'all'"
        (click)="setFilter('all')"
      >All ({{ splits().length }})</button>
      <button
        class="px-3 py-1.5 text-sm font-medium rounded-md border transition-colors"
        [class.bg-blue-50]="filterMode() === 'uncleared'"
        [class.text-blue-700]="filterMode() === 'uncleared'"
        [class.border-blue-200]="filterMode() === 'uncleared'"
        [class.text-gray-600]="filterMode() !== 'uncleared'"
        [class.border-transparent]="filterMode() !== 'uncleared'"
        [class.hover:bg-gray-50]="filterMode() !== 'uncleared'"
        (click)="setFilter('uncleared')"
      >Uncleared ({{ unclearedCount() }})</button>
      <button
        class="px-3 py-1.5 text-sm font-medium rounded-md border transition-colors"
        [class.bg-blue-50]="filterMode() === 'pending'"
        [class.text-blue-700]="filterMode() === 'pending'"
        [class.border-blue-200]="filterMode() === 'pending'"
        [class.text-gray-600]="filterMode() !== 'pending'"
        [class.border-transparent]="filterMode() !== 'pending'"
        [class.hover:bg-gray-50]="filterMode() !== 'pending'"
        (click)="setFilter('pending')"
      >Pending ({{ pendingCount() }})</button>
    </div>

  </div><!-- /page-header -->

  <!-- Scrollable split list -->
  <div class="page-content">
    <div class="card">
      <table>
        <thead>
          <tr>
            <th class="w-8"></th>
            <th>Date</th>
            <th>Ref</th>
            <th>Payee / Memo</th>
            <th class="text-right">Debit</th>
            <th class="text-right">Credit</th>
          </tr>
        </thead>
        <tbody>
          @if (reconcileData() === undefined) {
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-400 text-sm">Loading…</td>
            </tr>
          } @else if (filteredSplits().length === 0) {
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-400 text-sm">
                @if (splits().length === 0) {
                  No unreconciled transactions for this account.
                } @else {
                  No transactions match the current filter.
                }
              </td>
            </tr>
          } @else {
            @for (split of filteredSplits(); track split.split_id) {
              <tr
                class="row-clickable"
                [class.bg-blue-50]="split.is_pending"
                (click)="toggle(split.split_id)"
              >
                <td>
                  @if (split.is_pending) {
                    <svg class="w-7 h-7 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                    </svg>
                  } @else {
                    <svg class="w-7 h-7 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                    </svg>
                  }
                </td>
                <td class="whitespace-nowrap">{{ split.trandate | date:'MMM d, y' }}</td>
                <td class="text-gray-500">{{ split.tranref || '—' }}</td>
                <td>
                  <div class="cell-primary">{{ split.payee || '—' }}</div>
                  @if (split.memo) {
                    <div class="text-xs text-gray-400">{{ split.memo }}</div>
                  }
                </td>
                <td class="text-right tabular-nums">
                  @if (split.debit !== null) {
                    {{ split.debit | currency }}
                  }
                </td>
                <td class="text-right tabular-nums">
                  @if (split.credit !== null) {
                    {{ split.credit | currency }}
                  }
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </div><!-- /page-content -->

</div>
