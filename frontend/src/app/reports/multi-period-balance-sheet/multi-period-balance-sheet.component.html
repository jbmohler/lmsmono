<div class="page-container">
  <div class="page-header">
    <div class="flex items-center justify-between w-full">
      <div class="flex items-center gap-4">
        <a
          routerLink="/reports"
          class="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Reports
        </a>
        <h1 class="text-xl font-semibold text-gray-900">Multi-Period Balance Sheet</h1>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 input-compact">
          <label class="label-compact" for="report-month">Month:</label>
          <select id="report-month" [value]="reportMonth()" (change)="onMonthChange($event)">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="flex items-center gap-2 input-compact">
          <label class="label-compact" for="report-year">Year:</label>
          <input
            id="report-year"
            type="number"
            class="w-20"
            [value]="reportYear()"
            (change)="onYearChange($event)"
          />
        </div>
        <div class="flex items-center gap-2 input-compact">
          <label class="label-compact" for="report-periods">Periods:</label>
          <input
            id="report-periods"
            type="number"
            class="w-16"
            min="1"
            max="20"
            [value]="reportPeriods()"
            (change)="onPeriodsChange($event)"
          />
        </div>
        <button class="btn btn-primary" (click)="generate()">Generate</button>
      </div>
    </div>
  </div>

  <div class="page-content">
    <div class="flex h-full gap-4 md:gap-6">
      <div class="flex-1 overflow-x-auto overflow-y-auto">
        <div class="flex flex-col gap-4">
          @for (group of groups(); track group.atype_id) {
            <div class="card">
              <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">{{ group.atype_name }}</h2>
              </div>
              <table>
                <thead>
                  <tr>
                    <th class="sticky left-0 bg-white z-10">Account</th>
                    @for (p of periods(); track p) {
                      <th class="text-right whitespace-nowrap">{{ formatPeriodHeader(p) }}</th>
                    }
                  </tr>
                </thead>
                <tbody>
                  @for (acct of group.accounts; track acct.id) {
                    <tr
                      class="row-clickable"
                      [class.bg-blue-50]="selectedAccountId() === acct.id"
                      (click)="selectAccount(acct.id)"
                    >
                      <td class="sticky left-0 bg-inherit z-10">
                        <span class="cell-primary">{{ acct.acc_name }}</span>
                        @if (acct.description) {
                          <span class="text-xs text-gray-400 ml-2">{{ acct.description }}</span>
                        }
                      </td>
                      @for (bal of acct.balances; track $index) {
                        <td class="text-right tabular-nums whitespace-nowrap">{{ bal | currency }}</td>
                      }
                    </tr>
                  }
                </tbody>
                <tfoot>
                  <tr class="font-semibold">
                    <td class="sticky left-0 bg-white z-10">Total {{ group.atype_name }}</td>
                    @for (st of group.subtotals; track $index) {
                      <td class="text-right tabular-nums whitespace-nowrap">{{ st | currency }}</td>
                    }
                  </tr>
                </tfoot>
              </table>
            </div>
          }

          @if (groups().length > 0) {
            <div class="card">
              <table>
                <tbody>
                  <tr class="font-semibold">
                    <td class="sticky left-0 bg-white z-10">Total Assets</td>
                    @for (t of totalAssets(); track $index) {
                      <td class="text-right tabular-nums whitespace-nowrap">{{ t | currency }}</td>
                    }
                  </tr>
                  <tr class="font-semibold">
                    <td class="sticky left-0 bg-white z-10">Total Liabilities + Equity</td>
                    @for (t of totalLiabilitiesEquity(); track $index) {
                      <td class="text-right tabular-nums whitespace-nowrap">{{ t | currency }}</td>
                    }
                  </tr>
                </tbody>
              </table>
            </div>
          }

          @if (groups().length === 0) {
            <div class="card p-12 text-center text-gray-500 flex flex-col gap-1">
              <p class="text-sm">No balance sheet data for these parameters.</p>
              <p class="text-xs text-gray-400">Select a month, year, and number of periods, then click Generate.</p>
            </div>
          }
        </div>
      </div>

      @if (selectedAccountId(); as acctId) {
        <div class="w-[28rem] flex-shrink-0 overflow-y-auto rounded-lg border border-gray-200 bg-white">
          <app-account-sidebar
            [accountId]="acctId"
            (sidebarClose)="closeSidebar()"
            (transactionOpen)="openTransaction($event)"
            (accountEdit)="openAccountEdit($event)"
          />
        </div>
      }
    </div>
  </div>
</div>

@if (showEntryDialog()) {
  <app-transaction-entry
    [transactionId]="editTransactionId()"
    (dialogClose)="closeEntryDialog()"
    (dialogSave)="closeEntryDialog()"
  />
}

@if (showAccountEditDialog()) {
  <app-account-edit-dialog
    [accountId]="editAccountId()"
    (dialogClose)="closeAccountEditDialog()"
    (dialogSave)="onAccountSaved()"
  />
}
