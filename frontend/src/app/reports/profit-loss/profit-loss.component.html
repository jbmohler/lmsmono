<div class="page-container">
  <div class="page-header">
    <div class="flex items-center justify-between w-full">
      <div class="flex items-center gap-4">
        <a
          routerLink="/reports"
          class="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-900"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Reports
        </a>
        <h1 class="text-xl font-semibold text-gray-900">Profit &amp; Loss</h1>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 input-compact">
          <label class="label-compact" for="start-date">From:</label>
          <input
            id="start-date"
            type="date"
            [value]="startDate()"
            (change)="onStartDateChange($event)"
          />
        </div>
        <div class="flex items-center gap-2 input-compact">
          <label class="label-compact" for="end-date">To:</label>
          <input
            id="end-date"
            type="date"
            [value]="endDate()"
            (change)="onEndDateChange($event)"
          />
        </div>
        <button class="btn btn-primary" (click)="generate()">Generate</button>
      </div>
    </div>
  </div>

  <div class="page-content">
    <div class="flex h-full gap-4 md:gap-6">
      <div class="flex-1 overflow-y-auto">
        @if (groups().length > 0) {
          <div class="card max-w-3xl">
            <table>
              <thead>
                <tr>
                  <th>Account</th>
                  <th>Journal</th>
                  <th class="text-right">Amount</th>
                </tr>
              </thead>
              <tbody>
                @for (group of groups(); track group.atype_id; let first = $first) {
                  <tr class="group-header">
                    @if (!first) {
                      <td colspan="3" class="!p-0"><div class="h-4"></div></td>
                    }
                  </tr>
                  <tr class="group-header">
                    <td colspan="3" class="!py-2 bg-gray-50 text-sm font-semibold text-gray-700 uppercase tracking-wide">{{ group.atype_name }}</td>
                  </tr>
                  @for (acct of group.accounts; track acct.id) {
                    <tr
                      class="row-clickable"
                      [class.bg-blue-50]="selectedAccountId() === acct.id"
                      (click)="selectAccount(acct.id)"
                    >
                      <td>
                        <span class="cell-primary">{{ acct.acc_name }}</span>
                        @if (acct.description) {
                          <span class="text-xs text-gray-400 ml-2">{{ acct.description }}</span>
                        }
                      </td>
                      <td class="text-sm text-gray-500">{{ acct.journal.name }}</td>
                      <td class="text-right tabular-nums">{{ acct.amount | currency }}</td>
                    </tr>
                  }
                  <tr class="font-semibold">
                    <td colspan="2">Total {{ group.atype_name }}</td>
                    <td class="text-right tabular-nums">{{ group.subtotal | currency }}</td>
                  </tr>
                }
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="!p-0"><div class="h-4"></div></td>
                </tr>
                <tr class="font-semibold bg-gray-50">
                  <td colspan="2">Net Income</td>
                  <td
                    class="text-right text-sm font-bold tabular-nums"
                    [class.text-green-700]="netIncome() >= 0"
                    [class.text-red-700]="netIncome() < 0"
                  >
                    {{ netIncome() | currency }}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        }

        @if (groups().length === 0) {
          <div class="card max-w-3xl p-12 text-center text-gray-500 flex flex-col gap-1">
            <p class="text-sm">No profit &amp; loss data for this period.</p>
            <p class="text-xs text-gray-400">Select a date range and click Generate to view the report.</p>
          </div>
        }
      </div>

      @if (selectedAccountId(); as acctId) {
        <div class="w-[28rem] flex-shrink-0 overflow-y-auto rounded-lg border border-gray-200 bg-white">
          <app-account-sidebar
            [accountId]="acctId"
            (sidebarClose)="closeSidebar()"
            (transactionOpen)="openTransaction($event)"
            (accountEdit)="openAccountEdit($event)"
          />
        </div>
      }
    </div>
  </div>
</div>

@if (showEntryDialog()) {
  <app-transaction-entry
    [transactionId]="editTransactionId()"
    (dialogClose)="closeEntryDialog()"
    (dialogSave)="closeEntryDialog()"
  />
}

@if (showAccountEditDialog()) {
  <app-account-edit-dialog
    [accountId]="editAccountId()"
    (dialogClose)="closeAccountEditDialog()"
    (dialogSave)="onAccountSaved()"
  />
}
