<div class="h-full flex flex-col overflow-hidden">
  @if (isEditing()) {
    <!-- Edit Mode -->
    @if (editData(); as data) {
      <!-- Header -->
      <div class="dialog-header bg-white">
        <div class="flex items-center gap-2">
          <button (click)="cancelEdit(); back.emit()" class="md:hidden icon-btn" aria-label="Back">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h2 class="dialog-header-title">Edit Contact</h2>
        </div>
        <div class="dialog-actions">
          <button (click)="cancelEdit()" class="btn btn-secondary">
            Cancel
          </button>
          <button (click)="saveEdit()" class="btn btn-primary">
            Save
          </button>
        </div>
      </div>

      <!-- Edit Form -->
      <div class="flex-1 overflow-y-auto p-4 md:p-6 flex flex-col gap-4">
        <!-- Basic Info -->
        <div class="card p-4 flex flex-col gap-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @if (!data.isCorporate) {
              <div>
                <label class="label-compact">First Name</label>
                <input
                  type="text"
                  [ngModel]="data.firstName"
                  (ngModelChange)="updateField('firstName', $event)"
                />
              </div>
            }
            <div [class.col-span-2]="data.isCorporate">
              <label class="label-compact">
                {{ data.isCorporate ? 'Company Name' : 'Last Name' }}
              </label>
              <input
                type="text"
                [ngModel]="data.lastName"
                (ngModelChange)="updateField('lastName', $event)"
              />
            </div>
          </div>
          @if (!data.isCorporate) {
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="label-compact">Title</label>
                <input
                  type="text"
                  [ngModel]="data.title"
                  (ngModelChange)="updateField('title', $event)"
                  placeholder="Mr., Ms., Dr."
                />
              </div>
              <div>
                <label class="label-compact">Organization</label>
                <input
                  type="text"
                  [ngModel]="data.organization"
                  (ngModelChange)="updateField('organization', $event)"
                />
              </div>
            </div>
          }
        </div>

        <!-- Notes -->
        <div class="card p-4 flex flex-col gap-2">
          <label>Notes</label>
          <textarea
            [ngModel]="data.memo"
            (ngModelChange)="updateField('memo', $event)"
            rows="3"
          ></textarea>
        </div>
      </div>

      <!-- Footer -->
      <div class="hidden md:block px-4 md:px-6 py-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-500">
        Ctrl+S to save | Escape to cancel
      </div>
    }
  } @else {
    <!-- View Mode -->
    <!-- Header -->
    <div class="dialog-header bg-white">
      <div class="flex items-center gap-2 min-w-0">
        <button (click)="back.emit()" class="md:hidden icon-btn shrink-0" aria-label="Back">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <div class="min-w-0">
          <h2 class="text-xl font-semibold text-gray-900 truncate">{{ displayName() }}</h2>
          @if (!contact().isCorporate && contact().organization) {
            <p class="text-sm text-gray-500 truncate">{{ contact().organization }}</p>
          }
          @if (contact().isCorporate) {
            <p class="text-sm text-gray-500">Company</p>
          }
        </div>
      </div>
      @if (contact().isOwner !== false) {
        <button (click)="enterEditMode()" class="btn btn-secondary shrink-0">
          Edit
        </button>
      }
    </div>

    <!-- Sharing Row -->
    <div class="px-4 md:px-6 py-2 border-b border-gray-100 flex items-center gap-2 flex-wrap">
      @if (sharesLoading()) {
        <span class="text-xs text-gray-400">...</span>
      } @else {
        @for (share of shares(); track share.user.id) {
          <span class="inline-flex items-center gap-1 text-xs text-gray-600">
            @if (share.isOwner) {
              <span class="text-yellow-500">★</span>
            } @else {
              <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
            }
            {{ share.user.name }}
          </span>
        }
      }
      @if (contact().isOwner !== false) {
        <button (click)="openSharingDialog()" class="ml-auto text-xs text-blue-600 hover:text-blue-800">
          Manage
        </button>
      }
    </div>

    <!-- View Content -->
    <div class="flex-1 overflow-auto p-4 md:p-6 flex flex-col gap-4">
      <!-- Notes (shown first) -->
      @if (contact().memo) {
        <div class="flex flex-col gap-2">
          <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</h3>
          <p class="text-sm text-gray-700 whitespace-pre-line">{{ contact().memo }}</p>
        </div>
      }

      <!-- Add buttons for contact info (owner only) -->
      @if (contact().isOwner !== false) {
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-xs font-medium text-gray-500">Add:</span>
          <button (click)="addBitFromView('email')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Email</button>
          <button (click)="addBitFromView('phone')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Phone</button>
          <button (click)="addBitFromView('address')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Address</button>
          <button (click)="addBitFromView('url')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Link</button>
        </div>
      }

      @for (bit of sortedBits(); track trackById($index, bit); let first = $first; let last = $last) {
        <div class="bit-row flex items-center gap-2 md:-mx-2 md:px-2 py-1 rounded transition-colors hover:bg-gray-50 group">
          <!-- Action buttons (visible on hover, owner only) -->
          @if (contact().isOwner !== false) {
            <div class="icon-btn-group opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity shrink-0">
              <!-- Move up/down -->
              <div class="icon-btn-vertical">
                <button
                  (click)="moveBitFromView(bit.id, 'up'); $event.stopPropagation()"
                  [disabled]="first"
                  class="icon-btn icon-btn-move p-0.5"
                  title="Move up"
                >▲</button>
                <button
                  (click)="moveBitFromView(bit.id, 'down'); $event.stopPropagation()"
                  [disabled]="last"
                  class="icon-btn icon-btn-move p-0.5"
                  title="Move down"
                >▼</button>
              </div>
              <!-- Edit -->
              <button
                (click)="openBitDialog(bit); $event.stopPropagation()"
                class="icon-btn icon-btn-edit"
                title="Edit"
              >
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
              </button>
              <!-- Delete -->
              <button
                (click)="confirmDeleteBit(bit); $event.stopPropagation()"
                class="icon-btn icon-btn-delete"
                title="Delete"
              >
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          }

          <!-- Bit content (clickable for owners) -->
          <div
            class="flex-1 min-w-0"
            [class.cursor-pointer]="contact().isOwner !== false"
            (click)="contact().isOwner !== false && openBitDialog(bit)"
            (keydown.enter)="contact().isOwner !== false && openBitDialog(bit)"
            [attr.tabindex]="contact().isOwner !== false ? 0 : null"
            [attr.role]="contact().isOwner !== false ? 'button' : null"
          >
            @if (isEmail(bit)) {
              <div class="flex items-center gap-2 min-w-0 flex-wrap">
                @if (bit.isPrimary) {
                  <span class="primary-star">★</span>
                }
                <span class="badge badge-gray shrink-0">Email</span>
                <span class="text-sm text-blue-600 truncate">{{ bit.email }}</span>
                @if (bit.label) {
                  <span class="text-xs text-gray-400 shrink-0">({{ bit.label }})</span>
                }
              </div>
            }

            @if (isPhone(bit)) {
              <div class="flex items-center gap-2 min-w-0 flex-wrap">
                @if (bit.isPrimary) {
                  <span class="primary-star">★</span>
                }
                <span class="badge badge-gray shrink-0">Phone</span>
                <span class="text-sm text-gray-900">{{ bit.number }}</span>
                @if (bit.label) {
                  <span class="text-xs text-gray-400 shrink-0">({{ bit.label }})</span>
                }
              </div>
            }

            @if (isAddress(bit)) {
              <div class="flex items-start gap-2 min-w-0 flex-wrap">
                @if (bit.isPrimary) {
                  <span class="primary-star">★</span>
                }
                <span class="badge badge-gray shrink-0">Address</span>
                <div class="text-sm text-gray-900 whitespace-pre-line">{{ formatAddress(bit) }}</div>
                @if (bit.label) {
                  <span class="text-xs text-gray-400 shrink-0">({{ bit.label }})</span>
                }
              </div>
            }

            @if (isUrl(bit)) {
              <div class="flex items-center gap-2 min-w-0 flex-wrap">
                @if (bit.isPrimary) {
                  <span class="primary-star">★</span>
                }
                <span class="badge badge-gray shrink-0">Link</span>
                <span class="text-sm text-blue-600 truncate min-w-0">{{ bit.url }}</span>
                @if (bit.label) {
                  <span class="text-xs text-gray-400 shrink-0">({{ bit.label }})</span>
                }
                @if (bit.username) {
                  <span class="text-xs text-gray-400 shrink-0">@{{ bit.username }}</span>
                }
                @if (bit.hasPassword) {
                  @if (isPasswordExpired(bit)) {
                    <span class="expired-indicator shrink-0" title="Password expired">
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                    </span>
                  }
                  <button
                    (click)="copyPassword(bit); $event.stopPropagation()"
                    class="copy-password-btn shrink-0"
                    title="Copy password"
                  >
                    @if (copyingPasswordId() === bit.id) {
                      <span class="text-green-600">✓</span>
                    } @else {
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                      </svg>
                    }
                  </button>
                }
              </div>
            }
          </div>
        </div>
      } @empty {
        <p class="text-sm text-gray-400 italic">No contact info</p>
      }
    </div>

    <!-- Footer -->
    <div class="hidden md:block px-4 md:px-6 py-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-500">
      Hover for actions | Click to edit
    </div>
  }
</div>

<!-- Bit Edit Dialog -->
@if (editingBit(); as bit) {
  <app-bit-edit-dialog
    [contactId]="contact().id"
    [bit]="bit"
    (saved)="saveBitFromDialog($event)"
    (cancelled)="closeBitDialog()"
  />
}

<!-- Sharing Dialog -->
@if (showSharingDialog()) {
  <app-sharing-dialog
    [contactId]="contact().id"
    [isOwner]="contact().isOwner ?? true"
    (closed)="closeSharingDialog()"
    (sharesChanged)="onSharesChanged()"
  />
}
