<div class="h-full flex flex-col">
  @if (isEditing()) {
    <!-- Edit Mode -->
    @if (editData(); as data) {
      <!-- Header -->
      <div class="px-6 py-4 bg-white border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Edit Contact</h2>
        <div class="flex items-center gap-2">
          <button (click)="cancelEdit()" class="btn btn-secondary">
            Cancel
          </button>
          <button (click)="saveEdit()" class="btn btn-primary">
            Save
          </button>
        </div>
      </div>

      <!-- Edit Form -->
      <div class="flex-1 overflow-y-auto p-6 flex flex-col gap-4">
        <!-- Basic Info -->
        <div class="card p-4 flex flex-col gap-4">
          <div class="grid grid-cols-2 gap-4">
            @if (!data.isCorporate) {
              <div>
                <label class="label-compact">First Name</label>
                <input
                  type="text"
                  [ngModel]="data.firstName"
                  (ngModelChange)="updateField('firstName', $event)"
                  class="w-full"
                />
              </div>
            }
            <div [class.col-span-2]="data.isCorporate">
              <label class="label-compact">
                {{ data.isCorporate ? 'Company Name' : 'Last Name' }}
              </label>
              <input
                type="text"
                [ngModel]="data.lastName"
                (ngModelChange)="updateField('lastName', $event)"
                class="w-full"
              />
            </div>
          </div>
          @if (!data.isCorporate) {
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="label-compact">Title</label>
                <input
                  type="text"
                  [ngModel]="data.title"
                  (ngModelChange)="updateField('title', $event)"
                  placeholder="Mr., Ms., Dr."
                  class="w-full"
                />
              </div>
              <div>
                <label class="label-compact">Organization</label>
                <input
                  type="text"
                  [ngModel]="data.organization"
                  (ngModelChange)="updateField('organization', $event)"
                  class="w-full"
                />
              </div>
            </div>
          }
        </div>

        <!-- Contact Info (unified list) -->
        <div class="card p-4 input-compact flex flex-col gap-3">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-medium text-gray-700">Contact Info</h3>
            <div class="flex gap-2">
              <button (click)="addBit('email')" class="text-xs text-blue-600 hover:text-blue-800">+ Email</button>
              <button (click)="addBit('phone')" class="text-xs text-blue-600 hover:text-blue-800">+ Phone</button>
              <button (click)="addBit('address')" class="text-xs text-blue-600 hover:text-blue-800">+ Address</button>
              <button (click)="addBit('url')" class="text-xs text-blue-600 hover:text-blue-800">+ Link</button>
            </div>
          </div>

          @for (bit of editSortedBits(); track trackById($index, bit); let first = $first; let last = $last) {
            <div class="border border-gray-200 rounded-md p-3 flex flex-col gap-2">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <!-- Reorder buttons -->
                  <div class="flex flex-col gap-0.5">
                    <button
                      (click)="moveBitUp(bit.id)"
                      [disabled]="first"
                      class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed text-xs leading-none"
                      title="Move up"
                    >â–²</button>
                    <button
                      (click)="moveBitDown(bit.id)"
                      [disabled]="last"
                      class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed text-xs leading-none"
                      title="Move down"
                    >â–¼</button>
                  </div>
                  <!-- Primary star -->
                  <button
                    (click)="setPrimary(bit.id, bit.bitType)"
                    class="text-gray-400 hover:text-yellow-500"
                    [class.text-yellow-500]="bit.isPrimary"
                    title="Set as primary"
                  >
                    @if (bit.isPrimary) { â˜… } @else { â˜† }
                  </button>
                  <!-- Type badge -->
                  <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded">
                    {{ getBitTypeLabel(bit.bitType) }}
                  </span>
                  <!-- Label input -->
                  <input
                    type="text"
                    [ngModel]="bit.label"
                    (ngModelChange)="updateBit(bit.id, 'label', $event)"
                    placeholder="Label"
                    class="w-24"
                  />
                </div>
                <button (click)="removeBit(bit.id)" class="text-gray-400 hover:text-red-600">Ã—</button>
              </div>

              <!-- Type-specific fields -->
              @if (isEmail(bit)) {
                <input
                  type="email"
                  [ngModel]="bit.email"
                  (ngModelChange)="updateBit(bit.id, 'email', $event)"
                  placeholder="email@example.com"
                  class="w-full"
                />
              }

              @if (isPhone(bit)) {
                <input
                  type="tel"
                  [ngModel]="bit.number"
                  (ngModelChange)="updateBit(bit.id, 'number', $event)"
                  placeholder="(555) 123-4567"
                  class="w-full"
                />
              }

              @if (isAddress(bit)) {
                <div class="grid grid-cols-1 gap-2">
                  <input
                    type="text"
                    [ngModel]="bit.address1"
                    (ngModelChange)="updateBit(bit.id, 'address1', $event)"
                    placeholder="Address line 1"
                    class="w-full"
                  />
                  <input
                    type="text"
                    [ngModel]="bit.address2"
                    (ngModelChange)="updateBit(bit.id, 'address2', $event)"
                    placeholder="Address line 2"
                    class="w-full"
                  />
                  <div class="grid grid-cols-4 gap-2">
                    <input
                      type="text"
                      [ngModel]="bit.city"
                      (ngModelChange)="updateBit(bit.id, 'city', $event)"
                      placeholder="City"
                      class="col-span-2"
                    />
                    <input
                      type="text"
                      [ngModel]="bit.state"
                      (ngModelChange)="updateBit(bit.id, 'state', $event)"
                      placeholder="State"
                    />
                    <input
                      type="text"
                      [ngModel]="bit.zip"
                      (ngModelChange)="updateBit(bit.id, 'zip', $event)"
                      placeholder="ZIP"
                    />
                  </div>
                </div>
              }

              @if (isUrl(bit)) {
                <div class="flex gap-2">
                  <input
                    type="url"
                    [ngModel]="bit.url"
                    (ngModelChange)="updateBit(bit.id, 'url', $event)"
                    placeholder="https://..."
                    class="flex-1"
                  />
                  <input
                    type="text"
                    [ngModel]="bit.username"
                    (ngModelChange)="updateBit(bit.id, 'username', $event)"
                    placeholder="Username"
                    class="w-32"
                  />
                </div>
              }
            </div>
          } @empty {
            <p class="text-sm text-gray-400 italic">No contact info</p>
          }
        </div>

        <!-- Memo -->
        <div class="card p-4 flex flex-col gap-2">
          <label>Notes</label>
          <textarea
            [ngModel]="data.memo"
            (ngModelChange)="updateField('memo', $event)"
            rows="3"
            class="w-full"
          ></textarea>
        </div>
      </div>

      <!-- Footer -->
      <div class="px-6 py-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-500">
        Ctrl+S to save | Escape to cancel
      </div>
    }
  } @else {
    <!-- View Mode -->
    <!-- Header -->
    <div class="px-6 py-4 bg-white border-b border-gray-200 flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold text-gray-900">{{ displayName() }}</h2>
        @if (!contact().isCorporate && contact().organization) {
          <p class="text-sm text-gray-500">{{ contact().organization }}</p>
        }
        @if (contact().isCorporate) {
          <p class="text-sm text-gray-500">Company</p>
        }
      </div>
      <button (click)="enterEditMode()" class="btn btn-secondary">
        Edit
      </button>
    </div>

    <!-- View Content -->
    <div class="flex-1 overflow-y-auto p-6 flex flex-col gap-4">
      <!-- Add buttons for contact info -->
      <div class="flex items-center gap-2">
        <span class="text-xs font-medium text-gray-500">Add:</span>
        <button (click)="addBitFromView('email')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Email</button>
        <button (click)="addBitFromView('phone')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Phone</button>
        <button (click)="addBitFromView('address')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Address</button>
        <button (click)="addBitFromView('url')" class="text-xs text-blue-600 hover:text-blue-800 hover:underline">Link</button>
      </div>

      @for (bit of sortedBits(); track trackById($index, bit); let first = $first; let last = $last) {
        <div class="bit-row flex items-center gap-2 -mx-2 px-2 py-1 rounded transition-colors hover:bg-gray-50 group">
          <!-- Action buttons (visible on hover) -->
          <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
            <!-- Move up/down -->
            <div class="flex flex-col">
              <button
                (click)="moveBitFromView(bit.id, 'up'); $event.stopPropagation()"
                [disabled]="first"
                class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed text-xs leading-none p-0.5"
                title="Move up"
              >â–²</button>
              <button
                (click)="moveBitFromView(bit.id, 'down'); $event.stopPropagation()"
                [disabled]="last"
                class="text-gray-400 hover:text-gray-600 disabled:opacity-30 disabled:cursor-not-allowed text-xs leading-none p-0.5"
                title="Move down"
              >â–¼</button>
            </div>
            <!-- Edit -->
            <button
              (click)="openBitDialog(bit); $event.stopPropagation()"
              class="text-gray-400 hover:text-blue-600 p-1"
              title="Edit"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
            </button>
            <!-- Delete -->
            <button
              (click)="confirmDeleteBit(bit); $event.stopPropagation()"
              class="text-gray-400 hover:text-red-600 p-1"
              title="Delete"
            >
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>

          <!-- Bit content (clickable) -->
          <div
            class="flex-1 cursor-pointer"
            (click)="openBitDialog(bit)"
            (keydown.enter)="openBitDialog(bit)"
            tabindex="0"
            role="button"
          >
            @if (isEmail(bit)) {
              <div class="flex items-center gap-2">
                @if (bit.isPrimary) {
                  <span class="text-yellow-500 text-sm">â˜…</span>
                }
                <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Email</span>
                <span class="text-sm text-blue-600">{{ bit.email }}</span>
                @if (bit.label) {
                  <span class="text-xs text-gray-400">({{ bit.label }})</span>
                }
              </div>
            }

            @if (isPhone(bit)) {
              <div class="flex items-center gap-2">
                @if (bit.isPrimary) {
                  <span class="text-yellow-500 text-sm">â˜…</span>
                }
                <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Phone</span>
                <span class="text-sm text-gray-900">{{ bit.number }}</span>
                @if (bit.label) {
                  <span class="text-xs text-gray-400">({{ bit.label }})</span>
                }
              </div>
            }

            @if (isAddress(bit)) {
              <div class="flex items-start gap-2">
                @if (bit.isPrimary) {
                  <span class="text-yellow-500 text-sm">â˜…</span>
                }
                <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Address</span>
                <div class="text-sm text-gray-900 whitespace-pre-line">{{ formatAddress(bit) }}</div>
                @if (bit.label) {
                  <span class="text-xs text-gray-400">({{ bit.label }})</span>
                }
              </div>
            }

            @if (isUrl(bit)) {
              <div class="flex items-center gap-2">
                @if (bit.isPrimary) {
                  <span class="text-yellow-500 text-sm">â˜…</span>
                }
                <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded">Link</span>
                <span class="text-sm text-blue-600">{{ bit.url }}</span>
                @if (bit.label) {
                  <span class="text-xs text-gray-400">({{ bit.label }})</span>
                }
                @if (bit.username) {
                  <span class="text-xs text-gray-400">@{{ bit.username }}</span>
                }
                @if (bit.hasPassword) {
                  <span class="text-xs text-gray-400" title="Has password">ðŸ”’</span>
                }
              </div>
            }
          </div>
        </div>
      } @empty {
        <p class="text-sm text-gray-400 italic">No contact info</p>
      }

      <!-- Memo -->
      @if (contact().memo) {
        <div class="pt-4 border-t border-gray-200 flex flex-col gap-2">
          <h3 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</h3>
          <p class="text-sm text-gray-700 whitespace-pre-line">{{ contact().memo }}</p>
        </div>
      }
    </div>

    <!-- Footer -->
    <div class="px-6 py-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-500">
      Hover for actions | Click to edit
    </div>
  }
</div>

<!-- Bit Edit Dialog -->
@if (editingBit(); as bit) {
  <app-bit-edit-dialog
    [contactId]="contact().id"
    [bit]="bit"
    (saved)="saveBitFromDialog($event)"
    (cancelled)="closeBitDialog()"
  />
}
